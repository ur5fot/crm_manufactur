# Templates System - Complete Implementation Documentation

## Overview

The templates system is a comprehensive feature that allows users to create reusable DOCX templates with placeholders, upload template files, and generate personalized documents for employees with automatic placeholder replacement.

**Completed:** February 11, 2026

## Features Implemented

### 1. Templates CRUD System

Complete backend and frontend system for managing templates:
- Create new templates with name, type, and description
- View list of all active templates
- Edit template metadata (name, type, description)
- Soft delete templates (marked as inactive, not removed from database)
- Full audit logging for all template operations

### 2. DOCX Template Upload

Upload DOCX files with automatic placeholder detection:
- File upload with validation (.docx extension only)
- Automatic extraction of placeholders from DOCX content
- Storage in files/templates/ directory with unique filenames
- File size limit enforcement (configurable via config.csv)
- Template versioning via timestamp-based filenames

### 3. Document Generation

Generate personalized documents from templates:
- Merge employee data with template placeholders
- Support for all employee fields as placeholders
- Special auto-generated placeholders:
  - {current_date} - Current date in DD.MM.YYYY format
  - {current_datetime} - Current date/time in DD.MM.YYYY HH:MM format
- Automatic file creation in files/documents/ directory
- Data snapshot preservation (stores employee data at generation time)
- Concurrent generation support with CSV write locks

### 4. Document Download

Direct download of generated documents:
- Download endpoint with proper DOCX MIME type
- Content-Disposition headers for automatic filename
- Validation of document existence
- 404 handling for missing files

### 5. Document History View

Frontend interface for viewing generated documents:
- Navigation tab "Історія документів"
- Table view with columns:
  - Document ID
  - Template name
  - Employee name
  - Generation date
  - Generated by user
  - Download action button
- Advanced filtering:
  - Filter by template (dropdown)
  - Filter by employee (search)
  - Date range filter (start/end dates)
- Pagination (50 documents per page)
- Responsive UI with Bootstrap styling

### 6. Document History API

Backend endpoint for listing generated documents:
- GET /api/documents with query parameters
- Filtering support: template_id, employee_id, start_date, end_date
- Pagination: offset, limit parameters
- Joins with templates.csv and employees.csv for enriched data
- Sorted by generation_date DESC (newest first)
- Total count returned for pagination UI

### 7. Comprehensive Testing

Full test coverage across all levels:
- E2E tests for document generation and download flows
- E2E tests for templates CRUD and upload
- Unit tests for DOCX generator module
- Integration tests for templates API endpoints
- Concurrency tests for document generation

## Architecture

### Data Model

**templates.csv:**
- template_id (auto-increment)
- template_name
- template_type
- docx_filename
- placeholder_fields (comma-separated list)
- description
- created_date
- active ('yes'/'no' for soft delete)

**generated_documents.csv:**
- document_id (auto-increment)
- template_id
- employee_id
- docx_filename
- generation_date (ISO timestamp)
- generated_by (username, currently 'system')
- data_snapshot (JSON of employee data at generation time)

### File Structure

```
files/
  templates/          # Uploaded DOCX template files
    template_1_1234567890.docx
    template_2_1234567891.docx
  documents/          # Generated DOCX documents
    Contract_emp123_1234567890.docx
    Certificate_emp456_1234567891.docx
```

### Key Modules

**server/src/docx-generator.js:**
- extractPlaceholders(templatePath) - Extracts placeholder names from DOCX
- generateDocx(templatePath, data, outputPath) - Generates document with data

**server/src/store.js:**
- loadTemplates() - Load templates.csv with CSV locks
- saveTemplates(templates) - Save templates.csv with CSV locks
- loadGeneratedDocuments() - Load generated_documents.csv
- saveGeneratedDocuments(documents) - Save generated_documents.csv

**server/src/index.js:**
- API endpoints for templates and documents (see API Reference below)

## API Reference

### Templates API

#### GET /api/templates
List all active templates.

**Response:**
```json
{
  "templates": [
    {
      "template_id": "1",
      "template_name": "Contract Template",
      "template_type": "Employment Contract",
      "docx_filename": "template_1_1234567890.docx",
      "placeholder_fields": "first_name, last_name, position",
      "description": "Standard employment contract",
      "created_date": "2026-02-10",
      "active": "yes"
    }
  ]
}
```

#### GET /api/templates/:id
Get single template by ID.

**Response:**
```json
{
  "template": { /* template object */ }
}
```

**Errors:**
- 404: Template not found

#### POST /api/templates
Create new template.

**Request:**
```json
{
  "template_name": "Contract Template",
  "template_type": "Employment Contract",
  "description": "Standard employment contract"
}
```

**Response:**
```json
{
  "template_id": "1",
  "template": { /* full template object */ }
}
```

**Validation:**
- template_name is required
- template_type is required

**Audit log:** Creates "CREATE_TEMPLATE" log entry

#### PUT /api/templates/:id
Update template metadata.

**Request:**
```json
{
  "template_name": "Updated Name",
  "template_type": "Updated Type",
  "description": "Updated description"
}
```

**Response:**
```json
{
  "template": { /* updated template object */ }
}
```

**Notes:**
- Cannot change docx_filename (must re-upload)
- Cannot change placeholder_fields (auto-extracted on upload)
- Cannot change active status (use DELETE instead)

**Audit log:** Creates "UPDATE_TEMPLATE" log entry

#### DELETE /api/templates/:id
Soft delete template (sets active='no').

**Response:**
- 204 No Content

**Errors:**
- 404: Template not found

**Audit log:** Creates "DELETE_TEMPLATE" log entry

#### POST /api/templates/:id/upload
Upload DOCX file for template.

**Request:**
- Content-Type: multipart/form-data
- Field: file (DOCX file)

**Response:**
```json
{
  "filename": "template_1_1234567890.docx",
  "placeholders": ["first_name", "last_name", "position"]
}
```

**Validation:**
- File must be present
- File extension must be .docx
- File size must be under limit (default 10MB)
- Template ID must exist

**Side effects:**
- Uploads file to files/templates/
- Extracts placeholders from DOCX
- Updates template record with docx_filename and placeholder_fields

**Audit log:** Creates "UPLOAD_TEMPLATE_FILE" log entry

#### POST /api/templates/:id/generate
Generate document from template for an employee.

**Request:**
```json
{
  "employee_id": "emp123"
}
```

**Response:**
```json
{
  "document_id": "1",
  "filename": "Contract_emp123_1234567890.docx",
  "download_url": "/api/documents/1/download"
}
```

**Validation:**
- employee_id is required
- Template must exist
- Template must have docx_filename (DOCX uploaded)
- Employee must exist

**Side effects:**
- Generates DOCX file in files/documents/
- Creates record in generated_documents.csv
- Stores data snapshot (employee data at generation time)

**Audit log:** Creates "GENERATE_DOCUMENT" log entry

### Documents API

#### GET /api/documents
List generated documents with filtering and pagination.

**Query Parameters:**
- template_id (optional) - Filter by template ID
- employee_id (optional) - Filter by employee ID
- start_date (optional) - Filter by generation date >= start_date (YYYY-MM-DD)
- end_date (optional) - Filter by generation date <= end_date (YYYY-MM-DD)
- offset (optional, default: 0) - Pagination offset
- limit (optional, default: 50) - Pagination limit

**Response:**
```json
{
  "documents": [
    {
      "document_id": "1",
      "template_id": "1",
      "template_name": "Contract Template",
      "employee_id": "emp123",
      "employee_name": "Smith John",
      "docx_filename": "Contract_emp123_1234567890.docx",
      "generation_date": "2026-02-11T10:30:00.000Z",
      "generated_by": "system"
    }
  ],
  "total": 42,
  "offset": 0,
  "limit": 50
}
```

**Notes:**
- Documents are sorted by generation_date DESC (newest first)
- Joins with templates.csv and employees.csv for enriched data
- Returns "Unknown Template" / "Unknown Employee" if referenced records are deleted

#### GET /api/documents/:id/download
Download generated document file.

**Response:**
- Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
- Content-Disposition: attachment; filename="Contract_emp123_1234567890.docx"
- Body: DOCX file binary

**Errors:**
- 404: Document record not found in CSV
- 404: Document file not found on disk

## Placeholder Syntax

Templates use curly braces for placeholders: `{placeholder_name}`

### Employee Field Placeholders

Any field from the employee record can be used:
- {first_name}, {last_name}, {middle_name}
- {position}
- {birth_date}
- {passport_series}, {passport_number}
- {inn}, {snils}
- And any other employee field defined in schema.csv

### Special Placeholders

Auto-generated placeholders available in all templates:
- {current_date} - Current date in DD.MM.YYYY format (Ukrainian locale)
- {current_datetime} - Current date/time in DD.MM.YYYY HH:MM format

### Placeholder Handling

- Null/undefined values are replaced with empty string
- Unknown placeholders are left unchanged
- Placeholders are case-sensitive
- Placeholders can appear multiple times in template

## Testing

### E2E Tests

**tests/e2e/templates-crud.spec.js:**
- Create, read, update, delete templates
- Validation of required fields
- Soft delete behavior

**tests/e2e/templates-upload.spec.js:**
- DOCX upload flow
- Placeholder extraction
- File validation
- Error handling

**tests/e2e/templates-generation.spec.js:**
- Document generation flow
- Document download
- Error cases (missing DOCX, unsaved employee)
- Concurrent generation

### Unit Tests

**server/test/docx-generator.test.js:**
- extractPlaceholders() with various DOCX files
- generateDocx() with valid/invalid inputs
- Special placeholder generation
- Null/undefined value handling
- Error cases (missing files, invalid DOCX)

### Integration Tests

**server/test/templates-api.test.js:**
- All API endpoints with various scenarios
- Validation errors
- Audit logging
- Concurrent operations
- CSV write lock behavior

## Security Considerations

### Input Validation

- Template name and type are required
- DOCX file extension validation
- File size limit enforcement
- Employee ID validation before generation

### File System Security

- Template files stored in dedicated files/templates/ directory
- Generated documents stored in files/documents/ directory
- No direct access to CSV files via static routes
- Path traversal protection (resolved paths validated)

### Data Integrity

- CSV write locks prevent concurrent corruption
- Data snapshot stores employee data at generation time (prevents data loss if employee deleted)
- Soft delete for templates (preserves audit trail)
- Auto-increment IDs prevent ID conflicts

### Audit Logging

All template operations are logged:
- CREATE_TEMPLATE
- UPDATE_TEMPLATE
- DELETE_TEMPLATE
- UPLOAD_TEMPLATE_FILE
- GENERATE_DOCUMENT

Logs include: action, entity_id, entity_name, timestamp, details

## Performance Considerations

### CSV Performance

- In-memory processing (load entire CSV into memory)
- File locks prevent concurrent writes
- Suitable for small to medium datasets (< 10,000 records)
- For larger datasets, consider migrating to SQLite or PostgreSQL

### Document Generation

- Synchronous DOCX generation (blocks request until complete)
- No background job queue (suitable for low-volume usage)
- For high-volume usage, consider:
  - Background job queue (Bull, BullMQ)
  - Worker processes
  - Status polling endpoint

### Filtering and Pagination

- In-memory filtering and sorting
- Pagination reduces response size
- For better performance with large datasets:
  - Database indexes
  - Server-side pagination
  - Cached queries

## Future Enhancements Backlog

### 1. Batch Document Generation
- Generate documents for multiple employees at once
- Background job queue for large batches
- Progress tracking UI
- Email notification on completion

### 2. Template Versioning
- Track template file versions over time
- Allow regeneration with specific template version
- Version comparison UI
- Rollback to previous version

### 3. Custom Fields Beyond Employee Data
- Add custom placeholder fields to template definition
- User input form for custom fields during generation
- Store custom field values in data_snapshot
- Validate required custom fields

### 4. Template Usage Statistics
- Track generation count per template
- Most/least used templates report
- Generation trends over time
- Employee document count report

### 5. Automatic Cleanup of Old Documents
- Configurable retention period (e.g., 90 days)
- Scheduled cleanup job
- Archive to ZIP before deletion
- Cleanup report in admin UI

### 6. Document Re-generation
- Regenerate document with current employee data
- Compare old vs new data snapshot
- Audit trail for regenerations
- Version history for regenerated documents

### 7. Multi-language Support
- Template language field
- Locale-aware date formatting
- Translatable UI labels
- Language-specific placeholder names

### 8. Advanced Placeholder Features
- Conditional placeholders: {if:condition}...{/if}
- Loops for repeating data: {loop:items}...{/loop}
- Calculated fields: {age_years} from birth_date
- Format specifiers: {salary:currency}

### 9. Template Preview
- Preview template with sample data
- Highlight missing placeholders
- Preview in browser (convert DOCX to HTML)
- Print preview

### 10. User Authentication & Authorization
- Track generated_by with real username
- Role-based access control (template admin vs user)
- Employee self-service (download own documents)
- Approval workflow for document generation

### 11. Document Signatures
- Digital signature support
- Signature image upload
- Signature placeholder in template
- Signature verification

### 12. Email Integration
- Send generated document via email
- Email template configuration
- Attachment support
- Email delivery log

## Migration Notes

### From Manual Document Creation

If migrating from manual document creation:
1. Create template records for each document type
2. Convert existing DOCX files to templates (add placeholders)
3. Upload template files via API or UI
4. Train users on document generation flow
5. Archive old manual documents

### Database Migration (Future)

If migrating from CSV to database:
1. Create tables: templates, generated_documents
2. Import CSV data into tables
3. Update store.js to use database queries
4. Add indexes for filtering/sorting
5. Implement connection pooling
6. Update tests to use test database

## Troubleshooting

### Document Generation Fails

**Symptom:** Error message "DOCX generation failed"

**Causes:**
- Corrupted template DOCX file
- Invalid placeholder syntax in template
- Template file deleted from disk
- Insufficient disk space

**Solutions:**
- Re-upload template DOCX file
- Validate template in Word before upload
- Check files/templates/ directory exists and has write permissions
- Free up disk space

### Placeholder Not Replaced

**Symptom:** {placeholder} appears in generated document

**Causes:**
- Placeholder name doesn't match employee field
- Placeholder has typo
- Employee field is empty/null

**Solutions:**
- Check placeholder_fields in template record
- Verify employee has data for that field
- Use exact field names from schema.csv

### Concurrent Generation Corruption

**Symptom:** generated_documents.csv becomes corrupted or has duplicate IDs

**Causes:**
- Race condition in document ID generation
- Multiple processes writing simultaneously
- File lock not acquired

**Solutions:**
- Ensure store.js uses proper file locks
- Check that only one server instance is running
- Rebuild generated_documents.csv from backups

### File Size Limit Exceeded

**Symptom:** Upload fails with file size error

**Causes:**
- DOCX file exceeds max_file_upload_mb limit
- config.csv has too low value

**Solutions:**
- Compress DOCX file (remove embedded images, reduce quality)
- Increase max_file_upload_mb in config.csv
- Split large template into multiple templates

## Appendix: Example Template

See files/templates/example_contract.docx for a sample template.

Example placeholders:
```
CONTRACT OF EMPLOYMENT

Employee: {last_name} {first_name} {middle_name}
Position: {position}
Start Date: {employment_start_date}
Passport: {passport_series} {passport_number}
INN: {inn}

Date of Agreement: {current_date}
```

## Appendix: CSV File Formats

**templates.csv:**
```csv
template_id,template_name,template_type,docx_filename,placeholder_fields,description,created_date,active
1,Contract Template,Employment Contract,template_1_1234567890.docx,"first_name, last_name, position",Standard employment contract,2026-02-10,yes
```

**generated_documents.csv:**
```csv
document_id,template_id,employee_id,docx_filename,generation_date,generated_by,data_snapshot
1,1,emp123,Contract_emp123_1234567890.docx,2026-02-11T10:30:00.000Z,system,"{\"first_name\":\"John\",\"last_name\":\"Smith\"}"
```

## Contributors

- Claude Sonnet 4.5 (AI pair programmer)
- Human developer (project owner)

## License

Proprietary - Internal use only
