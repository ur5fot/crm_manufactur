# CRM на CSV (Vue + Node)

**[English version / Английская версия](README.md)**

Локальная CRM-система, которая хранит данные в CSV-файлах и PDF-документах. CSV-файлы можно безопасно редактировать в Excel, изменения автоматически загружаются при обновлении страницы.

## Возможности

- **Хранение в CSV** - не требуется база данных, редактируйте данные прямо в Excel
- **Динамический UI** - вся структура форм и таблиц управляется через `fields_schema.csv`
- **Последовательные числовые ID** - простые идентификаторы сотрудников (1, 2, 3...)
- **Управление файлами** - загрузка и хранение PDF-документов для каждого сотрудника
- **Сводная таблица** - inline редактирование двойным кликом, множественные фильтры с поддержкой пустых значений
- **Автоматическое логирование** - все изменения записываются в `logs.csv` с детализацией по полям
- **Импорт CSV** - массовая загрузка сотрудников из CSV-файлов
- **UTF-8 с BOM** - корректная поддержка кириллицы в Excel

## Технологический стек

- **Frontend:** Vue 3 + Vite
- **Backend:** Node.js + Express
- **Хранилище:** CSV файлы (UTF-8 с BOM)
- **Загрузка файлов:** Multer

## Структура проекта

```
crm_manufactur/
├── data/
│   ├── employees.csv              # Основные данные сотрудников (37 полей) - в gitignore
│   ├── fields_schema.csv          # Мета-схема: типы полей, метки, опции, UI конфигурация
│   ├── logs.csv                   # Журнал аудита всех изменений - в gitignore
│   ├── employees_import_sample.csv # Шаблон для импорта с UTF-8 BOM
├── files/                         # Загруженные PDF-документы - в gitignore
│   └── employee_[ID]/
├── server/                        # Backend на Express.js
└── client/                        # Frontend на Vue.js
```

## Быстрый старт

### Использование скрипта запуска

Запуск серверов:
```bash
./run.sh
```

Остановка серверов:
```bash
./stop.sh
```

### Ручной запуск

**Терминал 1 (сервер):**

```bash
cd server
npm install
npm run dev
```

**Терминал 2 (клиент):**

```bash
cd client
npm install
npm run dev
```

Откройте `http://localhost:5173` в браузере.

## Формат CSV

- **Разделитель:** `;` (точка с запятой) для совместимости с Excel
- **Кодировка:** UTF-8 с BOM для корректного отображения кириллицы в Excel
- **Строка заголовков:** Должна оставаться неизменной
- **ID сотрудников:** Последовательные числа (1, 2, 3...) вместо UUID
- **Пути к файлам:** Хранятся как относительные пути типа `files/employee_1/passport.pdf`

## Модель данных

### Основные таблицы

- **employees.csv** - Основные записи сотрудников (37 полей):
  1. `employee_id` - ID сотрудника (автоинкремент)
  2. `last_name` - Фамилия
  3. `first_name` - Имя
  4. `middle_name` - Отчество
  5. `employment_status` - Статус работы (Работает, Отпуск, Уволен, Больничный)
  6. `additional_status` - Дополнительный статус
  7. `location` - Местонахождение
  8. `department` - Подразделение
  9. `position` - Должность
  10. `grade` - Разряд (словами)
  11. `salary_grid` - Зарплатная сетка
  12. `salary_amount` - Оклад
  13. `specialty` - Специальность
  14. `work_state` - Рабочее состояние
  15. `work_type` - Тип работы (Полная ставка, Частичная занятость, Контракт)
  16. `gender` - Пол (Мужской, Женский)
  17. `fit_status` - Пригодность (Годен, Не годен, Ограниченно годен)
  18. `order_ref` - Приказ
  19. `bank_name` - Банк
  20. `bank_card_number` - Номер карты
  21. `bank_iban` - IBAN
  22. `tax_id` - ИНН
  23. `email` - Эл. почта
  24. `blood_group` - Группа крови (I (0), II (A), III (B), IV (AB))
  25. `workplace_location` - Место работы
  26. `residence_place` - Место проживания
  27. `registration_place` - Место регистрации
  28. `driver_license_file` - Водительское удостоверение (файл)
  29. `id_certificate_file` - Удостоверение личности (файл)
  30. `foreign_passport_number` - Номер загранпаспорта
  31. `foreign_passport_issue_date` - Дата выдачи загранпаспорта
  32. `foreign_passport_file` - Загранпаспорт (файл)
  33. `criminal_record_file` - Справка о несудимости (файл)
  34. `phone` - Телефон
  35. `phone_note` - Примечание к телефону
  36. `education` - Образование
  37. `notes` - Примечание

- **fields_schema.csv** - **Мета-схема управления UI** (8 колонок):
  - `field_order` - Порядковый номер (1-37)
  - `field_name` - Техническое название поля
  - `field_label` - Отображаемая метка (на русском)
  - `field_type` - Тип ввода: `text`, `select`, `textarea`, `number`, `email`, `tel`, `date`, `file`
  - `field_options` - Опции для select (разделены `|`), например: `Работает|Уволен|Отпуск`
  - `show_in_table` - Показывать в сводной таблице: `yes` / `no`
  - `field_group` - Группа для карточки сотрудника
  - `editable_in_table` - Разрешить inline редактирование: `yes` / `no`
  - **Чтобы изменить UI, просто отредактируйте этот файл и перезагрузите страницу!**

- **logs.csv** - Журнал аудита всех изменений (9 колонок):
  - `log_id` - ID записи лога
  - `timestamp` - Время изменения (ISO 8601)
  - `action` - Тип операции: `CREATE`, `UPDATE`, `DELETE`
  - `employee_id` - ID сотрудника
  - `employee_name` - ФИО на момент изменения
  - `field_name` - Измененное поле (для UPDATE)
  - `old_value` - Старое значение
  - `new_value` - Новое значение
  - `details` - Описание изменения

- **dictionaries.csv** - (устаревший, заменен на `fields_schema.csv`):
  - Сохранен для обратной совместимости, но не используется
  - Все опции dropdown теперь в `fields_schema.csv` → `field_options`

## Детальное описание возможностей

### Сводная таблица

Сводная таблица предоставляет мощные возможности фильтрации и редактирования:

**Взаимодействие:**
- **Двойной клик на ячейке** - Редактирование значения поля (для редактируемых полей)
- **Двойной клик на ID** - Открытие карточки сотрудника
- **Множественные фильтры** - Выбор нескольких значений одновременно для каждой колонки
- **Фильтр пустых значений** - Чекбокс "(Пусто)" для фильтрации строк с пустыми значениями
- **Сброс фильтров** - Кнопка для сброса всех активных фильтров одним кликом

**Поведение фильтров:**
- Чекбоксы для каждого уникального значения в select полях
- Опция пустого значения появляется первой в каждом фильтре
- Множественный выбор работает по логике OR
- Количество активных фильтров отображается в кнопке сброса

### Загрузка файлов

**Динамические типы документов:** Все поля с типом `file` в `fields_schema.csv` автоматически становятся доступны для загрузки в разделе Документы.

**Возможности:**
- Загрузка PDF-документов для каждого сотрудника
- Файлы сохраняются с правильными именами на основе типа поля (например, `driver_license_file.pdf`, `id_certificate_file.pdf`)
- Кнопка "Открыть папку" в разделе Документы открывает папку сотрудника в проводнике ОС
- Пути к файлам автоматически записываются в соответствующие колонки `employees.csv`
- Временная обработка файлов гарантирует правильное именование даже при задержке данных формы

**Добавление новых типов документов:**
Просто добавьте новую строку в `fields_schema.csv` с `field_type=file` - изменения кода не требуются!

### Импорт CSV

Шаблон доступен в интерфейсе или по пути `data/employees_import_sample.csv`.

**Важно:** Файл шаблона содержит UTF-8 BOM и корректную кодировку для совместимости с Excel. Используйте его как образец для правильного форматирования.

**Правила импорта:**
- Кодировка UTF-8 с BOM, разделитель `;`, первая строка — заголовки
- Заголовки должны совпадать с английскими названиями колонок из `employees.csv`
- Можно использовать только часть колонок - пропущенные поля будут пустыми
- Обязательные поля: хотя бы `last_name` или `first_name`
- `employee_id` опционален:
  - Если пустой: генерируется автоматически (следующий номер по порядку)
  - Если заполнен и уже существует: строка пропускается
- Формат даты: `YYYY-MM-DD` (например, `foreign_passport_issue_date`)
- Импортируются все поля сотрудника: личные данные, работа, контакты (phone, phone_note), образование, документы и т.д.

### Управление справочниками

Все значения выпадающих списков в формах управляются через `data/dictionaries.csv`:

1. Откройте `dictionaries.csv` в Excel
2. Добавьте новые строки с полями:
   - `dictionary_id` - следующий номер по порядку
   - `dictionary_type` - тип справочника (gender, blood_group и т.д.)
   - `value` - значение для сохранения в базе
   - `label` - отображаемый текст
   - `order_index` - порядок сортировки
3. Сохраните файл с кодировкой UTF-8 BOM
4. Обновите страницу в браузере

## API Endpoints

- `GET /api/employees` - Список всех сотрудников
- `GET /api/employees/:id` - Получить данные сотрудника (возвращает объект сотрудника)
- `POST /api/employees` - Создать сотрудника (принимает объект сотрудника)
- `PUT /api/employees/:id` - Обновить сотрудника (принимает объект сотрудника)
- `DELETE /api/employees/:id` - Удалить сотрудника
- `POST /api/employees/:id/files` - Загрузить PDF-документ
- `DELETE /api/employees/:id/files/:fieldName` - Удалить документ сотрудника
- `POST /api/employees/:id/open-folder` - Открыть папку с документами сотрудника в проводнике ОС
- `POST /api/employees/import` - Массовый импорт из CSV
- `GET /api/dictionaries` - Получить все справочные данные
- `GET /api/fields-schema` - Получить динамическую схему UI (типы полей, метки, опции)
- `POST /api/open-data-folder` - Открыть папку data в проводнике ОС

## Разработка

Для детальной архитектуры и рекомендаций по разработке см. [CLAUDE.md](CLAUDE.md).

## Лицензия

MIT
